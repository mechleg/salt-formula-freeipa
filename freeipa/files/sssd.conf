{%- if pillar.freeipa.server is defined -%}
  {%- from "freeipa/map.jinja" import server, ipa_servers with context -%}
  {%- set client = server -%}
{%- else -%}
  {%- from "freeipa/map.jinja" import client, ipa_servers with context -%}
{%- endif -%}

[domain/{{ client.domain }}]

cache_credentials = True
krb5_store_password_if_offline = True
ipa_domain = {{ client.domain }}
id_provider = ipa
auth_provider = ipa
access_provider = ipa
ipa_hostname = {{ client.get('hostname', grains['fqdn']) }}
chpass_provider = ipa
ipa_server = {{ '_srv_, ' if client.get('lookup', {}).get('kdc', False) else '' }}{{ ipa_servers|join(', ') }}
ipa_server_mode = True
ldap_tls_cacert = /etc/ipa/ca.crt

{%- if pillar.freeipa.server is not defined %}
dyndns_update = True
{%- endif %}
{%- if grains['roles'] is not defined or 'files' not in grains['roles'] %}
  {%- set services = "sudo, nss, ifp, pam, autofs, ssh" %}
autofs_provider = ipa
ipa_automount_location = default
{%- else %}
  {%- set services = "sudo, nss, ifp, pam, ssh" %}
{%- endif %}

[sssd]
services = {{ services }}

domains = {{ client.domain }}
[nss]
memcache_timeout = 600
homedir_substring = /home

[pam]

[sudo]

[autofs]

[ssh]

[pac]

[ifp]

[secrets]

{#-
vim: syntax=jinja
-#}
