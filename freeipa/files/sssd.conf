{%- set sssd_services = ['sudo', 'nss', 'pam', 'ssh'] -%}
{%- if pillar.freeipa.server is defined -%}
  {%- from "freeipa/map.jinja" import server, ipa_servers with context -%}
  {%- set client = server -%}
{%- else -%}
  {%- from "freeipa/map.jinja" import client, ipa_servers with context -%}
{%- endif -%}
{%- if 'idp' in salt['grains.get']('roles', []) or pillar.freeipa.server is defined -%}
  {%- set sssd_services = sssd_services + ['ifp'] -%}
{%- endif -%}

[domain/{{ client.domain }}]

cache_credentials = True
krb5_store_password_if_offline = True
ipa_domain = {{ client.domain }}
id_provider = ipa
auth_provider = ipa
access_provider = ipa
ipa_hostname = {{ client.get('hostname', grains['fqdn']) }}
chpass_provider = ipa
ipa_server = {{ '_srv_, ' if client.get('lookup', {}).get('kdc', False) else '' }}{{ ipa_servers|join(', ') }}
ldap_tls_cacert = /etc/ipa/ca.crt

{%- if pillar.freeipa.server is not defined %}
dyndns_update = True
{%- else %}
ipa_server_mode = True
{%- endif %}
{%- if grains['roles'] is not defined or 'files' not in grains['roles'] %}
  {%- set sssd_services = sssd_services + ['autofs'] %}
autofs_provider = ipa
ipa_automount_location = default
{%- endif %}
{%- if 'idp' in salt['grains.get']('roles', []) %}
ldap_user_extra_attrs = mail, street, locality, st, postalCode, telephoneNumber, givenname, sn
{%- endif %}

[sssd]
services = {{ sssd_services|join(', ') }}

domains = {{ client.domain }}
[nss]
{%- if pillar.freeipa.server is defined %}
memcache_timeout = 600
{%- endif %}
homedir_substring = /home

[pam]

[sudo]

[autofs]

[ssh]

[pac]

[ifp]
{%- if 'idp' in salt['grains.get']('roles', []) %}
user_attributes = +mail, +street, +locality, +st, +postalCode, +telephoneNumber, +givenname, +sn
allowed_uids = apache, root
{%- endif %}

[secrets]

{#-
vim: syntax=jinja
-#}
